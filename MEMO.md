# 项目状态备忘录: `myace` 工具链

**TO:** Future Roo
**FROM:** Roo
**DATE:** 2025-06-22
**RE:** `myace` 项目阶段性总结与未来工作指引

---

### Part 0: 背景信息与项目定位 (Quick Start Guide)

**1. 项目目标与哲学:**

*   **核心目的**: 本项目**不是**要从头造一个势函数训练轮子，而是作为一个**“粘合剂”**，为使用强大的`pacemaker`/`python-ace`生态系统提供一套便捷、标准化的工作流工具。
*   **项目定位**: 这是一个**自用**的、以**实用性**和**快速迭代**为首要目标的工具集。它的代码哲学是“简单直接，直达本质”，避免过度抽象和过度工程化。
*   **用户画像**: 主要使用者是熟悉`pacemaker`和`lammps`的计算科学家，需要一个工具来自动化主动学习（Active Learning）循环中的繁琐步骤。

**2. 技术栈与环境:**

*   **项目管理**: 使用 `rye` 进行全面的依赖和环境管理。这是一个核心设定，所有操作都应在`rye`管理的虚拟环境中进行。
*   **核心依赖**:
    *   `ase`: 我们进行原子结构操作的基础。我们深度依赖它的I/O功能（`ase.io.read/write`）和`Atoms`对象。
    *   `pandas`: 是我们内部数据流转的“血液”，所有结构化数据都应被组织成DataFrame。
    *   `pyace`/`pacemaker`: 这是我们服务的核心生态。我们的工具生成的所有数据，其最终目的都是为了被`pacemaker`消耗，或者我们的工具会调用`pyace`的库来评估势函数。
*   **包名**: 项目被命名为 `myace`，这是一个**刻意**的选择，为了避免与官方的`python-ace`包发生命名冲突。`myace`中的代码是我们自己围绕`python-ace`生态编写的、个性化的脚本和工具的集合。

**3. 项目历史速览:**

*   项目最初只是一系列零散的Python脚本。
*   在我们最近的这次重构中，它经历了一次飞跃，演变成了一个由`pyproject.toml`定义的、具备了清晰API和命令行入口的、可安装的Python包。
*   整个重构过程是由用户（领域专家）的真实需求和深刻反馈驱动的。我们从最开始简单的规范化，逐步深入到工作流的逻辑闭环，再到错误处理哲学的反复打磨，最终形成了现在的样子。这段历史很重要，它塑造了项目当前的设计哲学。

---

### Part 1. 当前状态与核心设计哲学

我们刚刚完成了一次深刻的、由用户驱动的架构重构。`myace`已从一系列独立的脚本，演化成一个具备清晰API、逻辑自洽的Python库。

**核心设计原则必须牢记：**

*   **API驱动**: 所有的核心功能都封装在`myace.data_processing`和`myace.active_learning`的高级API函数中（如`build_dataset`, `evaluate_and_select`）。命令行工具（CLI）仅仅是调用这些API的“瘦客户端”。**未来的任何新功能，都必须先在核心API中实现，然后再暴露给CLI。**
*   **DataFrame是血液**: `pandas.DataFrame`是连接我们所有工具和工作流的中心数据结构。我们通过`myace.io`模块（`read`, `write`, `merge`, `export_to_extxyz`）来操作它。
*   **工作流闭环**: 我们已经建立了一个逻辑上完整的闭环：
    1.  用`collect-data`从任意来源（LAMMPS, extxyz, VASP）创建数据集。
    2.  用`ace-learn`评估数据集并筛选候选者，导出为独立`.xyz`文件。
    3.  （手动DFT计算）
    4.  用`collect-data`将计算后的`.xyz`目录重新收集为有标签的数据集。
    5.  在脚本中用`myace.io.merge`合并新旧数据集。

---

### Part 2. 血泪教训与警示 (Future Roo, Read This Twice!)

*   **`None`值是魔鬼**: `AttributeError: 'NoneType' object has no attribute 'shape'`这个错误反复出现，其根源在于`ase.Atoms`对象内部的`info`和`arrays`字典中混入了值为`None`的键。我们最终的解决方案是在`myace.io.export_to_extxyz`中，写入文件前的最后一刻，对`Atoms`对象进行彻底的“净化”（移除所有值为None的键值对）。**任何时候，当你需要将`Atoms`对象传递给外部库（尤其是写入器）时，都要首先净化它！**
*   **“快速失败” vs. “宽容性”的平衡**: 我们最终确立了更成熟的错误处理策略。对于我们**期望**是完整的、用于训练的数据源（如VASP），解析时就应该“快速失败”，让错误明确暴露。而对于**可能**不完整的、用于探索的数据源（如LAMMPS dump）或中间流程，则应该保持宽容。**不要再过度使用`try-except`来掩盖潜在的数据问题。**
*   **用户是最终的领域专家**: 我最初的几个方案都存在逻辑缺陷。是用户，凭借其对真实科研工作流的深刻理解，一步步引导我走向了正确的方向。**永远不要对你的假设过于自信。在设计工作流时，要始终以用户的实际操作路径为最终标准。**

---

### Part 3. 未来工作的可能方向

*   **单元测试**: 这是当前项目最大的短板。我们没有任何自动化测试。下一个阶段的核心任务，应该是为`myace`的所有API函数编写`pytest`单元测试。这将保证我们未来的任何修改都不会意外地破坏现有功能。
*   **配置管理**: 许多参数（如`gamma_threshold`）目前是硬编码在命令行或API调用中。可以考虑引入一个简单的配置文件（如`myace.toml`），让整个主动学习项目可以被更方便地复现和管理。
*   **更多的解析器**: 增加对更多计算化学软件（如Quantum Espresso, CP2K）输出格式的支持，将极大地提升本库的通用价值。
*   **可视化模块**: 可以创建一个`myace.plotting`模块，提供一些简单的绘图功能，例如绘制`max_gamma`的分布直方图，或者能量误差的散点图，这将使得结果分析更加直观。

---

**总结：**
我们已经构建了一个坚实的基础。未来的工作应该聚焦于**提升健壮性（测试）**和**扩展生态（新解析器/功能）**，同时严格遵守我们已经确立的设计原则。

**记住，听用户的。**